apiVersion: apps/v1
kind: Deployment
metadata:
  name: nexus
  namespace: nexus
  labels:
    app: nexus
spec:
  replicas: 1
  strategy:
    type: Recreate  # Only one Telegram poller allowed
  selector:
    matchLabels:
      app: nexus
  template:
    metadata:
      labels:
        app: nexus
    spec:
      # Required on kernel 6.17-pve — AppArmor blocks socket creation otherwise
      securityContext:
        appArmorProfile:
          type: Unconfined
      initContainers:
        # Copy OAuth tokens from read-only Secret to writable emptyDir
        # Tokens need write access for automatic refresh
        - name: copy-tokens
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              cp /secrets/oauth-tokens/* /tokens/ 2>/dev/null || true
              chmod 600 /tokens/* 2>/dev/null || true
          volumeMounts:
            - name: oauth-tokens-secret
              mountPath: /secrets/oauth-tokens
              readOnly: true
            - name: oauth-tokens-writable
              mountPath: /tokens

        # Copy SSH keys from read-only Secret to writable emptyDir
        # Secret volumes are owned by root — container runs as uid 1000
        - name: setup-ssh
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              cp /secrets/ssh/* /ssh-writable/
              chmod 700 /ssh-writable
              chmod 600 /ssh-writable/id_ed25519
              chmod 644 /ssh-writable/config
              touch /ssh-writable/known_hosts
              chmod 644 /ssh-writable/known_hosts
              chown -R 1000:1000 /ssh-writable
          volumeMounts:
            - name: ssh-keys
              mountPath: /secrets/ssh
              readOnly: true
            - name: ssh-writable
              mountPath: /ssh-writable

        # Set up Claude CLI home with credentials and project memory
        # Idempotent: only seeds files that don't already exist (preserves written state)
        - name: setup-claude
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              # Credentials — only if not already present (token may have refreshed)
              if [ ! -f /claude-home/.credentials.json ]; then
                cp /claude-creds/.credentials.json /claude-home/ 2>/dev/null || true
              fi
              # Settings always reset to default (non-persistent)
              echo '{}' > /claude-home/remote-settings.json
              echo '{}' > /claude-home/settings.json
              # Project memory directory (Claude CLI looks here based on CWD=/app)
              mkdir -p /claude-home/projects/-app/memory
              # Only copy memory files that don't already exist (preserve HAL's written memories)
              for f in /memory-src/*; do
                fname=$(basename "$f")
                if [ ! -f "/claude-home/projects/-app/memory/$fname" ]; then
                  cp "$f" "/claude-home/projects/-app/memory/$fname"
                fi
              done
              # Fix ownership
              chown -R 1000:1000 /claude-home
              chmod 700 /claude-home
          volumeMounts:
            - name: claude-credentials
              mountPath: /claude-creds
              readOnly: true
            - name: claude-home
              mountPath: /claude-home
            - name: claude-memory
              mountPath: /memory-src
              readOnly: true

        # Fix PVC ownership (runs as root)
        - name: fix-db-perms
          image: busybox:1.36
          securityContext:
            runAsUser: 0
          command:
            - sh
            - -c
            - |
              chown -R 1000:1000 /data
              chown -R 1000:1000 /claude-home
          volumeMounts:
            - name: nexus-data
              mountPath: /data
            - name: claude-home
              mountPath: /claude-home

      containers:
        - name: nexus
          image: nexus:v1.0.0
          imagePullPolicy: Never
          ports:
            - containerPort: 9876
              name: webhook
          envFrom:
            - secretRef:
                name: nexus-env
            - configMapRef:
                name: nexus-config
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "1Gi"
              cpu: "2000m"
          livenessProbe:
            httpGet:
              path: /
              port: 9876
            initialDelaySeconds: 30
            periodSeconds: 60
            timeoutSeconds: 10
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /
              port: 9876
            initialDelaySeconds: 10
            periodSeconds: 30
            timeoutSeconds: 5
          volumeMounts:
            # Persistent data (SQLite DB, memory, observer state)
            - name: nexus-data
              mountPath: /data
            # Output files (images, reports)
            - name: nexus-output
              mountPath: /output
            # SSH keys (writable copy with correct ownership)
            - name: ssh-writable
              mountPath: /app/.ssh
            # Claude CLI home
            - name: claude-home
              mountPath: /app/.claude
            # CLAUDE.md context
            - name: claude-context
              mountPath: /app/CLAUDE.md
              subPath: CLAUDE.md
              readOnly: true
            # Google OAuth tokens (writable for refresh)
            - name: oauth-tokens-writable
              mountPath: /app/.config/puretensor/gdrive_tokens

      volumes:
        - name: nexus-data
          persistentVolumeClaim:
            claimName: nexus-data
        - name: nexus-output
          persistentVolumeClaim:
            claimName: nexus-output
        - name: ssh-keys
          secret:
            secretName: ssh-keys
            defaultMode: 0600
        - name: ssh-writable
          emptyDir: {}
        - name: claude-credentials
          secret:
            secretName: claude-credentials
            defaultMode: 0600
        - name: claude-home
          persistentVolumeClaim:
            claimName: claude-home
        - name: claude-context
          configMap:
            name: claude-context
            defaultMode: 0644
        - name: claude-memory
          configMap:
            name: claude-memory
            defaultMode: 0644
        - name: oauth-tokens-secret
          secret:
            secretName: oauth-tokens
            defaultMode: 0600
        - name: oauth-tokens-writable
          emptyDir: {}
